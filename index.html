<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹ ë°œ ë˜ì§€ê¸°: Infinite City</title>
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Pretendard', sans-serif; overflow: hidden; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        #ui { position: absolute; top: 15px; left: 15px; z-index: 10; color: #fff; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); pointer-events: none; display: none; font-size: 15px; font-weight: bold; }
        
        #selection-screen { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .shoe-option { background: #333; border: 2px solid #fff; border-radius: 15px; padding: 15px; margin: 8px; width: 80%; max-width: 300px; text-align: center; cursor: pointer; transition: 0.1s; }
        .shoe-option:active { transform: scale(0.95); background: #555; }
        
        #gauge-container { position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); width: 70%; height: 30px; background: rgba(0,0,0,0.5); border: 3px solid #fff; border-radius: 20px; display: none; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.5); pointer-events: none; }
        #gauge { width: 0%; height: 100%; background: linear-gradient(to right, #4caf50, #ffeb3b, #f44336); transition: width 0.05s linear; }
        #gauge-text { position: absolute; width: 100%; text-align: center; color: white; line-height: 30px; font-weight: bold; text-shadow: 1px 1px 2px #000; font-size: 14px; }

        #msg-popup { position: absolute; top: 40%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 20px; border-radius: 15px; font-weight: bold; display: none; z-index: 1000; text-align: center; white-space: pre-line; border: 2px solid gold; width: 70%; pointer-events: none; }
        
        canvas { display: block; }
    </style>
</head>
<body>

<div id="selection-screen">
    <h2 style="margin-bottom: 20px;">ğŸ™ï¸ Infinite City Run</h2>
    <div class="shoe-option" onclick="selectShoe('sneakers')">
        <strong>ğŸ‘Ÿ ìš´ë™í™”</strong><br>
        <span style="font-size:12px; color:#aaa;">ë‚´êµ¬ë„: 500 (í‘œì¤€)</span>
    </div>
    <div class="shoe-option" onclick="selectShoe('slipper')">
        <strong>ğŸ©´ ìŠ¬ë¦¬í¼</strong><br>
        <span style="font-size:12px; color:#aaa;">ë‚´êµ¬ë„: 250 (ì•½í•¨)</span>
    </div>
    <div class="shoe-option" onclick="selectShoe('leather')">
        <strong>ğŸ‘ ì •ì¥ êµ¬ë‘</strong><br>
        <span style="font-size:12px; color:#aaa;">ë‚´êµ¬ë„: 1000 (íŠ¼íŠ¼)</span>
    </div>
    <div class="shoe-option" onclick="selectShoe('boots')">
        <strong>ğŸ‘¢ ë¡± ë¶€ì¸ </strong><br>
        <span style="font-size:12px; color:#aaa;">ë‚´êµ¬ë„: 750 (íƒ„ë ¥)</span>
    </div>
</div>

<div id="ui">
    <div>ğŸš© ê±°ë¦¬: <span id="total-val">0</span>m</div>
    <div>ğŸš€ ê³ ë„: <span id="height-val">0</span>m</div>
    <div>ğŸ› ï¸ ë‚´êµ¬ë„: <span id="dur-val">0</span></div>
    <div style="margin-top:5px; font-size:12px; color:#ffeb3b;" id="terrain-info">ì§€í˜•: í‰ì§€</div>
</div>

<div id="msg-popup">ì•Œë¦¼</div>
<div id="gauge-container">
    <div id="gauge"></div>
    <div id="gauge-text">PRESS & HOLD</div>
</div>
<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gauge = document.getElementById('gauge');
    const gaugeText = document.getElementById('gauge-text');
    const popup = document.getElementById('msg-popup');
    
    const ui = {
        total: document.getElementById('total-val'),
        height: document.getElementById('height-val'),
        dur: document.getElementById('dur-val'),
        terrain: document.getElementById('terrain-info')
    };

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let state = { started: false, flying: false, charging: false, resetting: false };
    let physics = { power: 0, powerDir: 1, angle: -45, angleDir: 1, gravity: 0.25 };
    let shoe = { x: 100, y: 0, vx: 0, vy: 0, rotation: 0, startX: 100, lastSafeX: 100, lastSafeY: 0 };
    let shoeData = { name: "", color: "", weight: 1, maxDur: 1000, curDur: 1000 };
    
    // ì§€í˜•ê³¼ ë¹Œë”©ì„ ë”°ë¡œ ê´€ë¦¬
    let terrainSegments = [];
    let buildings = []; 
    let camera = { x: 0, y: 0 };
    let bgStars = [];
    
    // ë°°ê²½ íŒ¨ëŸ´ë™ìŠ¤ ì†ë„ (ì‘ì„ìˆ˜ë¡ ëŠë¦¬ê²Œ ì›€ì§ì„ = ë©€ë¦¬ ìˆëŠ” íš¨ê³¼)
    const PARALLAX_FACTOR = 0.2; 
    
    // ë³„ ìƒì„±
    for(let i=0; i<200; i++) {
        bgStars.push({
            x: Math.random() * window.innerWidth, 
            y: Math.random() * window.innerHeight, 
            s: Math.random() * 2,
            blink: Math.random()
        });
    }

    function selectShoe(type) {
        if(type === 'sneakers') shoeData = { name: "ìš´ë™í™”", color: "#d32f2f", weight: 1.0, maxDur: 500 };
        else if(type === 'slipper') shoeData = { name: "ìŠ¬ë¦¬í¼", color: "#eee", weight: 0.7, maxDur: 250 };
        else if(type === 'leather') shoeData = { name: "ì •ì¥êµ¬ë‘", color: "#000", weight: 1.5, maxDur: 1000 };
        else if(type === 'boots') shoeData = { name: "ë¡±ë¶€ì¸ ", color: "#5d4037", weight: 1.3, maxDur: 750 };

        shoeData.curDur = shoeData.maxDur;
        
        generateTerrain(0, 2000);
        // ì´ˆê¸° ë¹Œë”© ìƒì„± (í™”ë©´ë³´ë‹¤ í›¨ì”¬ ë„“ê²Œ ìƒì„±)
        generateBuildings(-1000, window.innerWidth * 2);

        shoe.y = getTerrainHeight(shoe.x) - 20;
        shoe.lastSafeY = shoe.y;

        document.getElementById('selection-screen').style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        document.getElementById('gauge-container').style.display = 'block';
        updateUI();
        state.started = true;
        loop();
    }

    // --- ë¹Œë”© ìƒì„± (íŒ¨ëŸ´ë™ìŠ¤ ì¢Œí‘œê³„ ê¸°ì¤€) ---
    function generateBuildings(startX, endX) {
        let x = startX;
        
        // ì´ë¯¸ ìƒì„±ëœ ë§ˆì§€ë§‰ ë¹Œë”© ë’¤ì—ì„œ ì‹œì‘
        if(buildings.length > 0) {
            let lastB = buildings[buildings.length-1];
            // ë§ˆì§€ë§‰ ë¹Œë”© ìœ„ì¹˜ê°€ ëª©í‘œ ì§€ì ë³´ë‹¤ ë©€ë©´ ìƒì„± ì•ˆ í•¨
            if(lastB.x > endX) return;
            x = lastB.x + lastB.w - 5; 
        }

        while(x < endX) {
            let w = 100 + Math.random() * 200; // ê±´ë¬¼ í­
            let h = 400 + Math.random() * 800; // ê±´ë¬¼ ë†’ì´ (ì•„ì£¼ ë†’ê²Œ)
            
            // ìƒ‰ìƒ ëœë¤ (íšŒìƒ‰í†¤)
            let colorVal = 30 + Math.random() * 30; 
            let color = `rgb(${colorVal}, ${colorVal}, ${colorVal + 20})`; 

            // ì°½ë¬¸ ë°ì´í„°
            let windows = [];
            let rows = Math.floor(h / 40);
            let cols = Math.floor(w / 25);
            for(let r=1; r<rows; r++) {
                for(let c=1; c<cols-1; c++) {
                    if(Math.random() > 0.5) {
                        windows.push({
                            x: c * 25, y: r * 40,
                            light: Math.random() > 0.4 
                        });
                    }
                }
            }

            // ê±´ë¬¼ì˜ Yìœ„ì¹˜ëŠ” í™”ë©´ ë°”ë‹¥ë³´ë‹¤ í›¨ì”¬ ì•„ë˜ì—ì„œ ì‹œì‘í•´ì„œ ìœ„ë¡œ ì†Ÿê²Œ ì„¤ì •
            buildings.push({ 
                x: x, 
                y: canvas.height + 400, // ê¸°ì¤€ì 
                w: w, 
                h: h, 
                color: color, 
                windows: windows 
            });
            
            x += w + Math.random() * 20 - 10; 
        }
    }

    function generateTerrain(startX, endX) {
        let x = startX;
        if(terrainSegments.length === 0) {
            terrainSegments.push({ x: 0, y: canvas.height * 0.8, type: 'grass' });
            x = 500;
        } else {
            x = terrainSegments[terrainSegments.length-1].x;
        }

        while(x < endX) {
            let prevY = terrainSegments[terrainSegments.length-1].y;
            let width = 200 + Math.random() * 300;
            let type = 'grass';
            let newY = prevY;

            let rand = Math.random();
            if (rand < 0.15) { 
                type = 'gap'; width = 200 + Math.random() * 200; 
            } else if (rand < 0.45) {
                newY = prevY - (Math.random() * 150 + 50); type = 'rock'; 
            } else if (rand < 0.75) {
                newY = prevY + (Math.random() * 150 + 50); type = 'grass'; 
            }

            if (newY > canvas.height + 400) newY = canvas.height;
            if (newY < -3000) newY = -2500;

            x += width;
            terrainSegments.push({ x: x, y: newY, type: type });
        }
    }

    function getTerrainHeight(x) {
        for(let i=0; i<terrainSegments.length-1; i++) {
            let p1 = terrainSegments[i];
            let p2 = terrainSegments[i+1];
            if(x >= p1.x && x < p2.x) {
                if(p1.type === 'gap') return 99999;
                let t = (x - p1.x) / (p2.x - p1.x);
                return p1.y + t * (p2.y - p1.y);
            }
        }
        return canvas.height * 0.8;
    }

    function getTerrainType(x) {
        for(let i=0; i<terrainSegments.length-1; i++) {
            if(x >= terrainSegments[i].x && x < terrainSegments[i+1].x) return terrainSegments[i].type;
        }
        return 'grass';
    }

    function loop() {
        if(!state.started) return;
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        // ì¹´ë©”ë¼ ì´ë™
        let targetCamX = shoe.x - canvas.width * 0.2;
        let targetCamY = shoe.y - canvas.height * 0.6;
        if(targetCamY > 300) targetCamY = 300; 
        
        camera.x += (targetCamX - camera.x) * 0.1;
        camera.y += (targetCamY - camera.y) * 0.1;

        // ì§€í˜• ë¬´í•œ ìƒì„± (ì‹ ë°œ ìœ„ì¹˜ ê¸°ì¤€)
        if(shoe.x + 2000 > terrainSegments[terrainSegments.length-1].x) {
            generateTerrain(terrainSegments[terrainSegments.length-1].x, shoe.x + 4000);
        }

        // [ì¤‘ìš”] ë¹Œë”© ë¬´í•œ ìƒì„± (íŒ¨ëŸ´ë™ìŠ¤ ì¹´ë©”ë¼ ê¸°ì¤€)
        // ë°°ê²½ ì¹´ë©”ë¼ëŠ” ì‹¤ì œ ì¹´ë©”ë¼ë³´ë‹¤ ëŠë¦¬ê²Œ ì›€ì§ì„ (PARALLAX_FACTOR)
        // ë”°ë¼ì„œ ìƒì„± ê¸°ì¤€ì ë„ ê·¸ì— ë§ì¶° ê³„ì‚°í•´ì•¼ í•¨
        let bgCameraX = camera.x * PARALLAX_FACTOR;
        let bgGenerationLimit = bgCameraX + window.innerWidth * 2; // í™”ë©´ ì˜¤ë¥¸ìª½ë³´ë‹¤ ë” ë©€ë¦¬ê¹Œì§€ ìƒì„±
        
        generateBuildings(0, bgGenerationLimit); // ì‹œì‘ì ì€ ë¬´ì‹œë˜ê³  ë§ˆì§€ë§‰ ê±´ë¬¼ ë’¤ì— ë¶™ìŒ
        
        // í™”ë©´ ì™¼ìª½ìœ¼ë¡œ ì™„ì „íˆ ë²—ì–´ë‚œ ë¹Œë”© ì œê±° (ë©”ëª¨ë¦¬ ê´€ë¦¬)
        if(buildings.length > 0) {
            // ë¹Œë”©ì˜ ì˜¤ë¥¸ìª½ ë(x+w)ì´ ë°°ê²½ ì¹´ë©”ë¼ì˜ ì™¼ìª½ ëë³´ë‹¤ ì‘ìœ¼ë©´ ì‚­ì œ
            if(buildings[0].x + buildings[0].w < bgCameraX - 500) {
                buildings.shift();
            }
        }

        if (!state.flying) {
            if(!state.resetting) {
                physics.angle += 2.5 * physics.angleDir;
                if(physics.angle > -15 || physics.angle < -75) physics.angleDir *= -1;
                
                if (state.charging) {
                    physics.power += 1.5 * physics.powerDir; 
                    if(physics.power >= 100 || physics.power <= 0) physics.powerDir *= -1;
                    
                    gauge.style.width = physics.power + "%";
                    gaugeText.innerText = Math.floor(physics.power) + "%";
                } else {
                    gauge.style.width = "0%";
                    gaugeText.innerText = "ê¾¹ ëˆŒëŸ¬ì„œ ë˜ì§€ê¸°!";
                }
            }
        } else {
            shoe.vx *= 0.995;
            shoe.vy += physics.gravity;
            shoe.x += shoe.vx;
            shoe.y += shoe.vy;
            shoe.rotation += shoe.vx * 0.1;

            let groundH = getTerrainHeight(shoe.x);
            let terrainType = getTerrainType(shoe.x);

            let altitude = Math.floor((groundH - shoe.y)/10);
            if(groundH > 10000) altitude = "ì¶”ë½ì¤‘";
            ui.height.innerText = altitude;
            ui.terrain.innerText = "ì§€í˜•: " + (terrainType==='gap'?"â˜ ï¸ ì ˆë²½":(terrainType==='rock'?"ğŸª¨ ê³µì‚¬ì¥":"ğŸ›£ï¸ ë„ë¡œ"));

            if (shoe.y >= groundH - 10 && terrainType !== 'gap') {
                handleCollision(groundH, terrainType);
            } 
            else if (shoe.y > groundH + 800 && terrainType === 'gap') {
                handlePitFall();
            }
        }
    }

    function handleCollision(groundH, type) {
        shoe.y = groundH - 10;
        shoe.vx = 0;
        shoe.vy = 0;
        state.flying = false;

        let impactDmg = 10 + Math.random() * 15; 
        if(type === 'rock') impactDmg *= 2.0; 

        applyDamage(impactDmg);

        shoe.lastSafeX = shoe.x;
        shoe.lastSafeY = shoe.y;
        shoe.startX = shoe.x;
        ui.total.innerText = Math.floor(shoe.x / 10);
    }

    function handlePitFall() {
        state.flying = false;
        shoe.vx = 0; shoe.vy = 0;
        applyDamage(50); 
        showPopup("ğŸ˜± ìœ¼ì•…! ë¹Œë”© ì‚¬ì´ë¡œ ì¶”ë½!\në‚´êµ¬ë„ -50\nì§ì „ ìœ„ì¹˜ë¡œ ë³µê·€");
        state.resetting = true;
        setTimeout(() => {
            shoe.x = shoe.lastSafeX;
            shoe.y = shoe.lastSafeY - 50;
            camera.x = shoe.x - canvas.width * 0.2;
            camera.y = shoe.y - canvas.height * 0.5;
            state.resetting = false;
            popup.style.display = 'none';
        }, 1200);
    }

    function applyDamage(amount) {
        shoeData.curDur -= amount;
        if(shoeData.curDur < 0) shoeData.curDur = 0;
        updateUI();

        if(shoeData.curDur <= 0) {
            showPopup(`ğŸ’¥ ${shoeData.name} íŒŒì†ë¨!\n\nğŸš© ìµœì¢… ê±°ë¦¬: ${Math.floor(shoe.x/10)}m`);
            setTimeout(() => location.reload(), 3000);
        }
    }

    function updateUI() {
        ui.dur.innerText = Math.floor(shoeData.curDur) + " / " + shoeData.maxDur;
        let ratio = shoeData.curDur / shoeData.maxDur;
        ui.dur.style.color = ratio < 0.2 ? '#ff3d00' : '#fff';
    }

    function showPopup(text) {
        popup.innerText = text;
        popup.style.display = 'block';
    }

    function getSkyColor() {
        const cycleLen = 25000; 
        let progress = (shoe.x % cycleLen) / cycleLen;

        const day = { t: "#87CEEB", b: "#E0F7FA" };
        const sunset = { t: "#4a148c", b: "#ff6f00" }; 
        const night = { t: "#000000", b: "#0d47a1" }; 
        const dawn = { t: "#4527a0", b: "#f8bbd0" };

        if(progress < 0.4) return [day.t, day.b, 0];
        else if (progress < 0.55) return [sunset.t, sunset.b, 0];
        else if (progress < 0.85) return [night.t, night.b, 1];
        else return [dawn.t, dawn.b, 0];
    }

    function draw() {
        const [topColor, botColor, starAlpha] = getSkyColor();

        // 1. í•˜ëŠ˜
        let skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        skyGradient.addColorStop(0, topColor);
        skyGradient.addColorStop(1, botColor);
        ctx.fillStyle = skyGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 2. ë³„ (ë°¤ì—ë§Œ)
        if(starAlpha > 0) {
            ctx.save();
            ctx.fillStyle = "#fff";
            // ë³„ë„ íŒ¨ëŸ´ë™ìŠ¤ ì ìš© (ì•„ì£¼ì•„ì£¼ ëŠë¦¬ê²Œ)
            let starParallax = camera.x * 0.05;
            
            bgStars.forEach(s => {
                let opacity = starAlpha * (0.5 + Math.sin(Date.now() * 0.005 + s.blink) * 0.5); 
                // í™”ë©´ ì•ˆì—ì„œ ë°˜ë³µë˜ë„ë¡ ëª¨ë“ˆëŸ¬ ì—°ì‚°
                let sx = (s.x - starParallax) % window.innerWidth;
                if(sx < 0) sx += window.innerWidth;
                
                let sy = s.y; // Yì¶•ì€ ê³ ì •
                
                ctx.globalAlpha = opacity;
                ctx.beginPath(); ctx.arc(sx, sy, s.s, 0, Math.PI*2); ctx.fill();
            });
            ctx.restore();
        }

        // 3. ë¹Œë”© (íŒ¨ëŸ´ë™ìŠ¤ ë ˆì´ì–´)
        ctx.save();
        // Xì¶•: ì¹´ë©”ë¼ ì†ë„ì˜ 20%ë¡œ ì´ë™ (ë©€ë¦¬ ìˆëŠ” íš¨ê³¼)
        // Yì¶•: ì¹´ë©”ë¼ ì†ë„ì˜ 10%ë¡œ ì´ë™ (ì‚´ì§ë§Œ ì›€ì§ì„)
        ctx.translate(-(camera.x * PARALLAX_FACTOR), -(camera.y * 0.1));
        
        buildings.forEach(b => {
            // ë¹Œë”© ê·¸ë¦¬ê¸° (ì ˆëŒ€ ì¢Œí‘œ b.x, b.y ì‚¬ìš©)
            // í™”ë©´ ë°– ìµœì í™”ëŠ” ìº”ë²„ìŠ¤ê°€ ì•Œì•„ì„œ ì²˜ë¦¬í•˜ì§€ë§Œ, ë£¨í”„ê°€ ë§ì•„ì§€ë©´ ìœ„ì—ì„œ ì²˜ë¦¬í•œ buildings.shiftê°€ ë„ì›€ë¨
            
            let renderY = b.y - b.h; // ë°”ë‹¥ ê¸°ì¤€ ë†’ì´ ì ìš©
            
            ctx.fillStyle = b.color;
            ctx.fillRect(b.x, renderY, b.w, b.h + 2000); // ë•… ë°‘ìœ¼ë¡œ ê¸¸ê²Œ

            b.windows.forEach(w => {
                // ì°½ë¬¸ ë†’ì´ê°€ ë„ˆë¬´ ë‚®ìœ¼ë©´(ë•…ì†) ê·¸ë¦¬ì§€ ì•ŠìŒ
                if(renderY + w.y < b.y + 500) {
                     if(starAlpha > 0.5 && w.light) {
                        ctx.fillStyle = "rgba(255, 235, 59, 0.9)";
                        ctx.shadowBlur = 5; ctx.shadowColor = "yellow"; 
                    } else {
                        ctx.fillStyle = "rgba(0,0,0,0.3)";
                        ctx.shadowBlur = 0;
                    }
                    ctx.fillRect(b.x + w.x, renderY + w.y, 10, 15);
                    ctx.shadowBlur = 0;
                }
            });
        });
        ctx.restore();

        // 4. ì§€í˜• ë° ì‹ ë°œ (ë©”ì¸ ë ˆì´ì–´)
        ctx.save();
        ctx.translate(-camera.x, -camera.y);

        // ì§€í˜• ê·¸ë¦¬ê¸°
        ctx.beginPath();
        if(terrainSegments.length > 0) {
            ctx.moveTo(terrainSegments[0].x, terrainSegments[0].y);
            for(let i=0; i<terrainSegments.length-1; i++) {
                let p1 = terrainSegments[i];
                let p2 = terrainSegments[i+1];
                if(p1.type === 'gap') {
                    ctx.lineTo(p1.x, canvas.height + 3000); 
                    ctx.lineTo(p2.x, canvas.height + 3000);
                    ctx.lineTo(p2.x, p2.y);
                } else {
                    ctx.lineTo(p2.x, p2.y);
                }
            }
        }
        ctx.lineTo(terrainSegments[terrainSegments.length-1].x, canvas.height + 3000);
        ctx.lineTo(terrainSegments[0].x, canvas.height + 3000);
        ctx.closePath();
        
        ctx.fillStyle = starAlpha > 0.5 ? "#263238" : "#546E7A"; 
        ctx.fill();
        
        ctx.lineWidth = 4;
        for(let i=0; i<terrainSegments.length-1; i++) {
            let p1 = terrainSegments[i];
            let p2 = terrainSegments[i+1];
            if(p1.type !== 'gap') {
                ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
                ctx.strokeStyle = p1.type === 'rock' ? "#3E2723" : (starAlpha > 0.5 ? "#102027" : "#37474F");
                ctx.stroke();
            }
        }

        // ì‹ ë°œ ê·¸ë¦¬ê¸°
        if(!state.resetting) {
            ctx.save();
            ctx.translate(shoe.x, shoe.y);
            
            if(state.charging) {
                ctx.translate(Math.random()*2 - 1, Math.random()*2 - 1);
            }
            
            ctx.rotate(shoe.rotation);
            ctx.fillStyle = shoeData.color;
            ctx.beginPath();
            if(shoeData.name === "ë¡±ë¶€ì¸ ") {
                ctx.rect(-15, -10, 30, 15); ctx.rect(5, -30, 10, 30);
            } else if(shoeData.name === "ìŠ¬ë¦¬í¼") {
                ctx.rect(-15, -5, 30, 8); ctx.fillStyle="#fff"; ctx.rect(-5,-5,10,2);
            } else {
                ctx.rect(-15, -10, 30, 15);
                if(shoeData.name==="ì •ì¥êµ¬ë‘") { ctx.fillStyle="#000"; ctx.fillRect(-15,-5,30,5); }
            }
            ctx.fill();
            ctx.restore();
        }

        // í™”ì‚´í‘œ
        if (!state.flying && !state.resetting && state.started) {
            ctx.save();
            ctx.translate(shoe.x, shoe.y);
            ctx.rotate(physics.angle * Math.PI/180);
            
            let arrowLen = 50 + physics.power;
            ctx.strokeStyle = `rgb(${255}, ${255-physics.power*2.5}, 0)`;
            ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(arrowLen, 0); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(arrowLen, 0); ctx.lineTo(arrowLen-10, -5); ctx.lineTo(arrowLen-10, 5); ctx.fill();
            ctx.restore();
        }
        ctx.restore();
    }

    function handleStart(e) {
        if(e.target.className.includes('shoe-option')) return;
        if(!state.started || state.flying || state.resetting) return;
        if(e.cancelable) e.preventDefault(); 
        state.charging = true;
    }

    function handleEnd(e) {
        if(!state.started) return;
        if(state.charging) {
            state.charging = false;
            
            let force = (physics.power * 0.4 + 12) / shoeData.weight;
            let rad = physics.angle * Math.PI / 180;
            shoe.vx = Math.cos(rad) * force;
            shoe.vy = Math.sin(rad) * force;
            
            physics.power = 0;
            gauge.style.width = "0%";
            ui.terrain.innerText = "ë¹„í–‰ì¤‘...";
            state.flying = true;
        }
    }

    document.addEventListener('mousedown', handleStart);
    document.addEventListener('touchstart', handleStart, {passive: false});
    document.addEventListener('mouseup', handleEnd);
    document.addEventListener('touchend', handleEnd);

</script>
</body>
</html>
